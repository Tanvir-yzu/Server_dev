{% extends 'DevOps/base.html' %}
{% load static %}

{% block title %}Update Collaborator Role - {{ project.project_name }}{% endblock %}

{% block extra_css %}
<style>
    .collaborator-form-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .form-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #007bff;
    }
    
    .form-header h2 {
        color: #007bff;
        margin: 0;
        font-size: 24px;
    }
    
    .project-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    
    .collaborator-info {
        background-color: #e9ecef;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .collaborator-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        margin: 0 auto 15px;
    }
    
    .collaborator-name {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .collaborator-email {
        color: #6c757d;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .role-description {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        text-align: center;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #545b62;
        transform: translateY(-1px);
    }
    
    .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }
    
    .breadcrumb {
        background-color: transparent;
        padding: 0;
        margin-bottom: 20px;
    }
    
    .breadcrumb-item {
        display: inline;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: " > ";
        color: #6c757d;
        padding: 0 8px;
    }
    
    .breadcrumb-item a {
        color: #007bff;
        text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
        text-decoration: underline;
    }
    
    .breadcrumb-item.active {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="collaborator-form-container">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'DevOps:project_list' %}">Projects</a></li>
            <li class="breadcrumb-item"><a href="{% url 'DevOps:project_detail' project.pk %}">{{ project.project_name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'collaboration:collaborator_list' project.pk %}">Collaborators</a></li>
            <li class="breadcrumb-item active" aria-current="page">Update Role</li>
        </ol>
    </nav>

    <div class="form-card">
        <div class="form-header">
            <h2>üîß Update Collaborator Role</h2>
        </div>

        <!-- Project Information -->
        <div class="project-info">
            <strong>Project:</strong> {{ project.project_name }}
            {% if project.description %}
                <br><small>{{ project.description|truncatewords:20 }}</small>
            {% endif %}
        </div>

        <!-- Collaborator Information -->
        <div class="collaborator-info">
            <div class="collaborator-avatar">
                {{ object.user.full_name|first|upper }}
            </div>
            <div class="collaborator-name">{{ object.user.full_name }}</div>
            <div class="collaborator-email">{{ object.user.email }}</div>
            <small class="text-muted">
                Added on {{ object.added_at|date:"F d, Y" }} by {{ object.added_by.full_name }}
            </small>
        </div>

        <!-- Warning for role changes -->
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Important:</strong> Changing a collaborator's role will immediately affect their permissions in this project.
        </div>

        <!-- Form -->
        <form method="post">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <div class="form-group">
                <label for="{{ form.role.id_for_label }}" class="form-label">
                    Select New Role
                </label>
                <select name="{{ form.role.name }}" id="{{ form.role.id_for_label }}" class="form-control" required>
                    {% for value, label in form.role.field.choices %}
                        <option value="{{ value }}" {% if value == form.role.value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                
                {% if form.role.errors %}
                    <div class="text-danger mt-2">
                        {{ form.role.errors }}
                    </div>
                {% endif %}

                <!-- Role Descriptions -->
                <div class="role-description">
                    <strong>Role Permissions:</strong><br>
                    <strong>Viewer:</strong> Can view project details and progress<br>
                    <strong>Contributor:</strong> Can view and contribute to project development<br>
                    <strong>Admin:</strong> Can manage project settings, collaborators, and invitations
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    üíæ Update Role
                </button>
                <a href="{% url 'collaboration:collaborator_list' project.pk %}" class="btn btn-secondary">
                    ‚ùå Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('{{ form.role.id_for_label }}');
    const roleDescription = document.querySelector('.role-description');
    
    // Role descriptions
    const descriptions = {
        'viewer': 'Viewers can see project details, progress, and documentation but cannot make changes.',
        'contributor': 'Contributors can view project details and actively participate in development activities.',
        'admin': 'Admins have full access to manage the project, including collaborators and settings.'
    };
    
    // Update description based on selected role
    function updateDescription() {
        const selectedRole = roleSelect.value;
        if (descriptions[selectedRole]) {
            roleDescription.innerHTML = `<strong>Selected Role:</strong> ${descriptions[selectedRole]}`;
        }
    }
    
    // Update description on change
    roleSelect.addEventListener('change', updateDescription);
    
    // Set initial description
    updateDescription();
    
    // Confirmation before submitting
    document.querySelector('form').addEventListener('submit', function(e) {
        const collaboratorName = '{{ object.user.full_name }}';
        const newRole = roleSelect.options[roleSelect.selectedIndex].text;
        
        if (!confirm(`Are you sure you want to change ${collaboratorName}'s role to ${newRole}?`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}