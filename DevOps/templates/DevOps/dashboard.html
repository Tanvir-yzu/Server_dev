{% extends 'base.html' %}
{% load static %}

{% block title %}DevOps Dashboard{% endblock %}
{% block content %}
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    
    <!-- Main Content -->
    <div class="container mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 lg:py-10">
        
        <!-- Header Section -->
        <div class="mb-6 sm:mb-8 lg:mb-12">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 sm:gap-6">
                <div class="text-center lg:text-left">
                    <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                        Welcome back, <span class="text-blue-600 block sm:inline">{{ user.first_name|default:user.email|truncatechars:15 }}</span>! 👋
                    </h1>
                    <p class="text-base sm:text-lg text-gray-600">Manage your DevOps projects and track deployments</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full lg:w-auto">
                    <a href="{% url 'devops:project_create' %}" 
                       class="inline-flex items-center justify-center px-4 sm:px-6 py-2.5 sm:py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 text-sm sm:text-base">
                        <i class="fas fa-plus mr-2"></i>New Project
                    </a>
                    <a href="{% url 'collaboration:my_invitations' %}" 
                       class="inline-flex items-center justify-center px-4 sm:px-6 py-2.5 sm:py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 text-sm sm:text-base">
                        <i class="fas fa-envelope mr-2"></i>Invitations
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 sm:gap-6 mb-8 sm:mb-10">
            <!-- Total Projects Card -->
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Total Projects</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-900">{{ total_projects }}</p>
                        <div class="flex flex-col sm:flex-row sm:items-center mt-2 text-xs sm:text-sm gap-1 sm:gap-0">
                            <span class="text-blue-600 font-medium">{{ owned_projects }} owned</span>
                            {% if collaborated_projects > 0 %}
                                <span class="text-gray-400 mx-2 hidden sm:inline">•</span>
                                <span class="text-green-600 font-medium">{{ collaborated_projects }} shared</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-3 sm:p-4 bg-blue-100 rounded-2xl flex-shrink-0">
                        <i class="fas fa-project-diagram text-xl sm:text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>

            <!-- Deployed Projects Card -->
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Deployed</p>
                        <p class="text-2xl sm:text-3xl font-bold text-green-600">{{ deployed_projects }}</p>
                        <div class="flex items-center mt-2">
                            {% if total_projects > 0 %}
                                {% widthratio deployed_projects total_projects 100 as deployment_rate %}
                                <div class="flex items-center text-xs sm:text-sm text-gray-600">
                                    <span class="text-green-600 font-medium">{{ deployment_rate }}%</span>
                                    <span class="ml-1">success rate</span>
                                </div>
                            {% else %}
                                <span class="text-xs sm:text-sm text-gray-500">No projects yet</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-3 sm:p-4 bg-green-100 rounded-2xl flex-shrink-0">
                        <i class="fas fa-check-circle text-xl sm:text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>

            <!-- Pending Projects Card -->
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Pending</p>
                        <p class="text-2xl sm:text-3xl font-bold text-yellow-600">{{ pending_projects }}</p>
                        <div class="mt-2">
                            {% if pending_projects > 0 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1"></i>In Progress
                                </span>
                            {% else %}
                                <span class="text-xs sm:text-sm text-gray-500">All up to date</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-3 sm:p-4 bg-yellow-100 rounded-2xl flex-shrink-0">
                        <i class="fas fa-clock text-xl sm:text-2xl text-yellow-600"></i>
                    </div>
                </div>
            </div>

            <!-- Failed Projects Card -->
            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Failed</p>
                        <p class="text-2xl sm:text-3xl font-bold text-red-600">{{ failed_projects }}</p>
                        <div class="mt-2">
                            {% if failed_projects > 0 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Needs Attention
                                </span>
                            {% else %}
                                <span class="text-xs sm:text-sm text-gray-500">No issues</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-3 sm:p-4 bg-red-100 rounded-2xl flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-xl sm:text-2xl text-red-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Recent Projects Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
            
            <!-- Quick Actions Panel -->
            <div class="lg:col-span-1 order-2 lg:order-1">
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <i class="fas fa-bolt text-blue-600 mr-2 sm:mr-3"></i>Quick Actions
                    </h3>
                    <div class="space-y-3 sm:space-y-4">
                        <a href="{% url 'devops:project_create' %}" 
                           class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-xl transition-all duration-300 group">
                            <div class="p-2 sm:p-3 bg-blue-600 rounded-xl mr-3 sm:mr-4 group-hover:scale-110 transition-transform duration-300 flex-shrink-0">
                                <i class="fas fa-plus text-white text-sm sm:text-base"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-semibold text-gray-900 text-sm sm:text-base">Create Project</p>
                                <p class="text-xs sm:text-sm text-gray-600">Start a new DevOps project</p>
                            </div>
                        </a>

                        <a href="{% url 'devops:project_list' %}" 
                           class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 rounded-xl transition-all duration-300 group">
                            <div class="p-2 sm:p-3 bg-gray-600 rounded-xl mr-3 sm:mr-4 group-hover:scale-110 transition-transform duration-300 flex-shrink-0">
                                <i class="fas fa-list text-white text-sm sm:text-base"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-semibold text-gray-900 text-sm sm:text-base">View All Projects</p>
                                <p class="text-xs sm:text-sm text-gray-600">Manage your projects</p>
                            </div>
                        </a>

                        <a href="{% url 'collaboration:my_collaborations' %}" 
                           class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 rounded-xl transition-all duration-300 group">
                            <div class="p-2 sm:p-3 bg-green-600 rounded-xl mr-3 sm:mr-4 group-hover:scale-110 transition-transform duration-300 flex-shrink-0">
                                <i class="fas fa-users text-white text-sm sm:text-base"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-semibold text-gray-900 text-sm sm:text-base">My Collaborations</p>
                                <p class="text-xs sm:text-sm text-gray-600">Projects you're part of</p>
                            </div>
                        </a>

                        <a href="{% url 'collaboration:my_invitations' %}" 
                           class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded-xl transition-all duration-300 group">
                            <div class="p-2 sm:p-3 bg-purple-600 rounded-xl mr-3 sm:mr-4 group-hover:scale-110 transition-transform duration-300 flex-shrink-0">
                                <i class="fas fa-envelope text-white text-sm sm:text-base"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-semibold text-gray-900 text-sm sm:text-base">Pending Invitations</p>
                                <p class="text-xs sm:text-sm text-gray-600">Review collaboration requests</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Projects Panel -->
            <div class="lg:col-span-2 order-1 lg:order-2">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                    <div class="p-4 sm:p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <h3 class="text-lg sm:text-xl font-bold text-gray-900 flex items-center">
                                <i class="fas fa-history text-blue-600 mr-2 sm:mr-3"></i>Recent Projects
                            </h3>
                            <a href="{% url 'devops:project_list' %}" 
                               class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors duration-200 self-start sm:self-auto">
                                View All →
                            </a>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        {% if recent_projects %}
                            <div class="space-y-3 sm:space-y-4">
                                {% for project in recent_projects %}
                                    <div class="group p-3 sm:p-4 border border-gray-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all duration-300">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div class="flex items-center min-w-0 flex-1">
                                                <div class="p-2 sm:p-3 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 mr-3 sm:mr-4 flex-shrink-0">
                                                    <i class="fas fa-code-branch text-blue-600 text-sm sm:text-base"></i>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-1">
                                                        <a href="{% url 'devops:project_detail' project.pk %}" 
                                                           class="font-semibold text-gray-900 hover:text-blue-600 transition-colors duration-200 truncate text-sm sm:text-base">
                                                            {{ project.project_name }}
                                                        </a>
                                                        <!-- Role Badge -->
                                                        {% if project.owner == user %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 self-start">
                                                                👑 Owner
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 self-start">
                                                                🤝 Collaborator
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <p class="text-xs sm:text-sm text-gray-600 truncate">{{ project.domain_name }}</p>
                                                    <p class="text-xs text-gray-500 mt-1">Updated {{ project.created_at|timesince }} ago</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between sm:justify-end gap-3 sm:gap-4 flex-shrink-0">
                                                <!-- Status Badge -->
                                                <span class="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs font-medium
                                                    {% if project.deployment_status == 'deployed' %}bg-green-100 text-green-800
                                                    {% elif project.deployment_status == 'pending' %}bg-yellow-100 text-yellow-800
                                                    {% elif project.deployment_status == 'failed' %}bg-red-100 text-red-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {% if project.deployment_status == 'deployed' %}
                                                        <i class="fas fa-check-circle mr-1"></i>
                                                    {% elif project.deployment_status == 'pending' %}
                                                        <i class="fas fa-clock mr-1"></i>
                                                    {% elif project.deployment_status == 'failed' %}
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                                    {% endif %}
                                                    <span class="hidden sm:inline">{{ project.get_deployment_status_display }}</span>
                                                    <span class="sm:hidden">
                                                        {% if project.deployment_status == 'deployed' %}✓
                                                        {% elif project.deployment_status == 'pending' %}⏳
                                                        {% elif project.deployment_status == 'failed' %}⚠️
                                                        {% else %}—{% endif %}
                                                    </span>
                                                </span>
                                                
                                                <!-- Action Buttons -->
                                                <div class="flex gap-1 sm:gap-2 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-300">
                                                    <a href="{% url 'devops:server_code' project.pk %}" 
                                                       class="p-1.5 sm:p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors duration-200"
                                                       title="View Code">
                                                        <i class="fas fa-code text-xs sm:text-sm"></i>
                                                    </a>
                                                    <a href="{% url 'devops:project_detail' project.pk %}" 
                                                       class="p-1.5 sm:p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors duration-200"
                                                       title="View Details">
                                                        <i class="fas fa-eye text-xs sm:text-sm"></i>
                                                    </a>
                                                    {% if project.owner == user %}
                                                        <a href="{% url 'collaboration:collaborator_list' project_id=project.pk %}" 
                                                           class="p-1.5 sm:p-2 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors duration-200"
                                                           title="Manage Team">
                                                            <i class="fas fa-users text-xs sm:text-sm"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8 sm:py-12">
                                <div class="p-4 sm:p-6 bg-gray-100 rounded-full w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-4 sm:mb-6 flex items-center justify-center">
                                    <i class="fas fa-folder-open text-2xl sm:text-3xl text-gray-400"></i>
                                </div>
                                <h4 class="text-base sm:text-lg font-semibold text-gray-700 mb-2">No projects yet</h4>
                                <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6 max-w-md mx-auto px-4">
                                    Start your DevOps journey by creating your first project and begin tracking deployments.
                                </p>
                                <a href="{% url 'devops:project_create' %}" 
                                   class="inline-flex items-center px-4 sm:px-6 py-2.5 sm:py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 text-sm sm:text-base">
                                    <i class="fas fa-plus mr-2"></i>Create Your First Project
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced JavaScript for better interactions -->
    <script>
        // Add smooth scroll behavior
        document.documentElement.style.scrollBehavior = 'smooth';

        // Add loading states for action buttons
        document.querySelectorAll('a[href*="create"], a[href*="edit"]').forEach(link => {
            link.addEventListener('click', function(e) {
                const icon = this.querySelector('i');
                if (icon && !icon.classList.contains('fa-spin')) {
                    const originalClass = icon.className;
                    icon.className = 'fas fa-spinner fa-spin mr-2';
                    
                    // Reset icon after 3 seconds if page doesn't navigate
                    setTimeout(() => {
                        if (icon) {
                            icon.className = originalClass;
                        }
                    }, 3000);
                }
            });
        });

        // Add hover effects for cards with touch support
        document.querySelectorAll('.group').forEach(card => {
            card.addEventListener('mouseenter', function() {
                if (window.innerWidth >= 640) { // Only on larger screens
                    this.style.transform = 'translateY(-2px)';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });

            // Touch support for mobile devices
            card.addEventListener('touchstart', function() {
                this.style.transform = 'translateY(-1px)';
            });

            card.addEventListener('touchend', function() {
                setTimeout(() => {
                    this.style.transform = 'translateY(0)';
                }, 150);
            });
        });

        // Auto-refresh statistics every 30 seconds (only on desktop)
        if (window.innerWidth >= 1024) {
            setInterval(() => {
                // Only refresh if user is active (has interacted recently)
                if (document.hasFocus()) {
                    fetch(window.location.href, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }).then(response => {
                        if (response.ok) {
                            // Optionally update statistics without full page reload
                            console.log('Statistics refreshed');
                        }
                    }).catch(err => {
                        console.log('Auto-refresh failed:', err);
                    });
                }
            }, 30000);
        }

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                // Force a reflow to handle any layout issues
                document.body.style.display = 'none';
                document.body.offsetHeight; // Trigger reflow
                document.body.style.display = '';
            }, 100);
        });

        // Optimize for mobile performance
        if ('ontouchstart' in window) {
            // Disable hover effects on touch devices
            document.documentElement.classList.add('touch-device');
            
            // Add CSS for touch devices
            const style = document.createElement('style');
            style.textContent = `
                .touch-device .group:hover {
                    transform: none !important;
                }
                .touch-device .opacity-0 {
                    opacity: 1 !important;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
{% endblock %}